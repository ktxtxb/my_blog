<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ñ–∏–ª—å - –ë–õ–û–ì –°–ï–õ–ï–î–ö–ò</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #1e3a5f;
            color: #e0e0e0;
        }
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
        }
        .header {
            background: #2c5282;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .profile-card {
            background: #2d3748;
            border: 2px solid #cbd5e0;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .user-info {
            margin-bottom: 20px;
        }
        .user-info div {
            margin-bottom: 10px;
            padding: 10px;
            background: #1a202c;
            border-radius: 4px;
        }
        .btn {
            background: #4a90a4;
            color: #ffffff;
            padding: 12px 25px;
            text-decoration: none;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
            display: inline-block;
        }
        .btn:hover { background: #63b3d1; }
        .btn-edit { background: #38a169; }
        .btn-back { background: #4a5568; }
        .user-posts {
            margin-top: 30px;
        }
        .post-item {
            background: #1a202c;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4a90a4;
        }
        .error { color: #ff6b6b; margin-top: 10px; }
        .success { color: #51cf66; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</h1>
        </div>

        <div id="profileContent">
            <div class="profile-card">
                <div class="user-info">
                    <div><strong>–õ–æ–≥–∏–Ω:</strong> <span id="userLogin"></span></div>
                    <div><strong>Email:</strong> <span id="userEmail"></span></div>
                    <div><strong>ID:</strong> <span id="userId"></span></div>
                    <div><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="userStatus"></span></div>
                    <div><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</strong> <span id="userCreated"></span></div>
                </div>

                <div>
                    <button onclick="editProfile()" class="btn btn-edit">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–§–ò–õ–¨</button>
                    <a href="/" class="btn btn-back">‚Üê –ù–ê –ì–õ–ê–í–ù–£–Æ</a>
                </div>
            </div>

            <div class="user-posts">
                <h3>–ú–û–ò –†–ï–¶–ï–ü–¢–´:</h3>
                <div id="userPostsList"></div>
            </div>
            <div class="user-favorites" style="margin-top: 40px;">
                <h3>‚ù§Ô∏è –ú–û–ò –ò–ó–ë–†–ê–ù–ù–´–ï –†–ï–¶–ï–ü–¢–´:</h3>
                <div id="favoritePostsList"></div>
            </div>

        </div>

        <div id="editForm" style="display: none;">
            <div class="profile-card">
                <h3>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø</h3>
                <form id="profileForm">
                    <div style="margin-bottom: 15px;">
                        <label><strong>–õ–æ–≥–∏–Ω:</strong></label>
                        <input type="text" id="editLogin" style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label><strong>Email:</strong></label>
                        <input type="email" id="editEmail" style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label><strong>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è):</strong></label>
                        <input type="password" id="editPassword" style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>

                    <div id="message" class="error"></div>

                    <div>
                        <button type="submit" class="btn btn-edit">–°–û–•–†–ê–ù–ò–¢–¨</button>
                        <button type="button" onclick="cancelEdit()" class="btn btn-back">–û–¢–ú–ï–ù–ê</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    let currentUser = null;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω
    async function checkAndRefreshToken() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            window.location.href = '/login';
            return null;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å –∫ API
        try {
            const response = await fetch('/api/users/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                console.log('‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω');
                return token;
            } else {
                console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
                localStorage.removeItem('token');
                localStorage.removeItem('user_id');
                localStorage.removeItem('login');
                localStorage.removeItem('is_admin');
                window.location.href = '/login';
                return null;
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
            return null;
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
    async function loadProfile() {
        const token = await checkAndRefreshToken();
        if (!token) return;

        const userId = localStorage.getItem('user_id');

        try {
            console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userResponse = await fetch(`/api/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!userResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

            currentUser = await userResponse.json();
            displayUserInfo(currentUser);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const postsResponse = await fetch('/api/posts/');
            if (postsResponse.ok) {
                const allPosts = await postsResponse.json();
                const userPosts = allPosts.filter(post => post.author_id == userId);
                displayUserPosts(userPosts);
            }
            await loadFavoritePosts(token);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
            window.location.href = '/login';
        }
    }

    function displayUserInfo(user) {
        document.getElementById('userLogin').textContent = user.login;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userId').textContent = user.id;
        document.getElementById('userStatus').textContent = user.is_admin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('userCreated').textContent = new Date(user.created_at).toLocaleDateString('ru-RU');
    }

    function displayUserPosts(posts) {
        const postsList = document.getElementById('userPostsList');
        if (posts.length === 0) {
            postsList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤</p>';
            return;
        }

        postsList.innerHTML = posts.map(post => `
            <div class="post-item">
                <h4>${post.title}</h4>
                <p>${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                <small>–°–æ–∑–¥–∞–Ω: ${new Date(post.created_at).toLocaleDateString('ru-RU')}</small>
                <div style="margin-top: 10px;">
                    <a href="/posts/${post.id}" class="btn" style="padding: 5px 10px; font-size: 14px;">–ß–ò–¢–ê–¢–¨</a>
                    <a href="/edit/${post.id}" class="btn btn-back" style="padding: 5px 10px; font-size: 14px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨</a>
                </div>
            </div>
        `).join('');
    }

    async function loadFavoritePosts(token) {
        if (!token) {
            console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
            return;
        }

        try {
            console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã...');

            const response = await fetch('/api/favorites/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            console.log('üìä –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                const favorites = await response.json();
                console.log('‚úÖ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', favorites);
                displayFavoritePosts(favorites);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', response.status);
                if (response.status === 401) {
                    console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –æ—á–∏—â–∞–µ–º localStorage');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('login');
                    localStorage.removeItem('is_admin');
                    window.location.href = '/login';
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
        }
    }

    function displayFavoritePosts(posts) {
        const container = document.getElementById('favoritePostsList');
        console.log('üé® –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã:', posts);

        if (posts.length === 0) {
            container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤</p>';
            console.log('üìù –ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            return;
        }

        container.innerHTML = posts.map(post => `
            <div class="post-item">
                <h4>${post.title}</h4>
                <p>${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                <small>–ê–≤—Ç–æ—Ä: ${post.author_login} | –°–æ–∑–¥–∞–Ω: ${new Date(post.created_at).toLocaleDateString('ru-RU')}</small>
                <div style="margin-top: 10px;">
                    <a href="/posts/${post.id}" class="btn" style="padding: 5px 10px; font-size: 14px;">–ß–ò–¢–ê–¢–¨</a>
                    <button onclick="removeFromFavorites(${post.id})" class="btn btn-back" style="padding: 5px 10px; font-size: 14px;">
                        ‚ùå –£–î–ê–õ–ò–¢–¨ –ò–ó –ò–ó–ë–†–ê–ù–ù–û–ì–û
                    </button>
                </div>
            </div>
        `).join('');

        console.log('‚úÖ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    async function removeFromFavorites(postId) {
        const token = await checkAndRefreshToken();
        if (!token) return;

        try {
            console.log(`üóëÔ∏è –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç ${postId} –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`);

            const response = await fetch(`/api/favorites/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                console.log('‚úÖ –ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                alert('–†–µ—Ü–µ–ø—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                await loadFavoritePosts(token);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', response.status);
                if (response.status === 401) {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                    window.location.href = '/login';
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        }
    }

    function editProfile() {
        document.getElementById('profileContent').style.display = 'none';
        document.getElementById('editForm').style.display = 'block';

        document.getElementById('editLogin').value = currentUser.login;
        document.getElementById('editEmail').value = currentUser.email;
    }

    function cancelEdit() {
        document.getElementById('profileContent').style.display = 'block';
        document.getElementById('editForm').style.display = 'none';
        document.getElementById('message').textContent = '';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const token = await checkAndRefreshToken();
        if (!token) return;

        const updateData = {
            login: document.getElementById('editLogin').value,
            email: document.getElementById('editEmail').value
        };

        const newPassword = document.getElementById('editPassword').value;
        if (newPassword) {
            updateData.password = newPassword;
        }

        try {
            const response = await fetch(`/api/users/${currentUser.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                document.getElementById('message').textContent = '–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!';
                document.getElementById('message').className = 'success';
                setTimeout(() => {
                    cancelEdit();
                    loadProfile(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                }, 1500);
            } else {
                const error = await response.json();
                document.getElementById('message').textContent = '–û—à–∏–±–∫–∞: ' + error.detail;
                document.getElementById('message').className = 'error';
            }
        } catch (error) {
            document.getElementById('message').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
            document.getElementById('message').className = 'error';
        }
    });

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ—Ñ–∏–ª—è...');
        loadProfile();
    });
</script>
</body>
</html>