<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ë–õ–û–ì –ü–†–û –°–ï–õ–ï–î–ö–ò</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #1e3a5f;
            color: #e0e0e0;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #2c5282;
            padding: 30px;
            border-bottom: 3px solid #cbd5e0;
            margin-bottom: 30px;
        }
        .post {
            background: #2d3748;
            border: 2px solid #cbd5e0;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: left;
        }
        .btn {
            background: #4a90a4;
            color: #ffffff;
            padding: 12px 25px;
            text-decoration: none;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px;
            display: inline-block;
            cursor: pointer;
        }
        .btn:hover {
            background: #63b3d1;
        }
        .btn-secondary {
            background: #4a5568;
            color: #cbd5e0;
        }
        .btn-danger {
            background: #e53e3e;
        }
        .btn-success {
            background: #38a169;
        }
        h1 {
            color: #cbd5e0;
            font-size: 2.5em;
            margin: 0;
        }
        .post h3 {
            color: #cbd5e0;
            border-bottom: 1px solid #4a90a4;
            padding-bottom: 10px;
        }
        .user-info {
            margin-top: 15px;
            padding: 10px;
            background: #2c5282;
            border-radius: 5px;
        }
        .post-meta {
            color: #a0aec0;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .nav-buttons {
            margin-top: 15px;
        }
        .like-btn {
            background: none;
            border: 1px solid #e53e3e;
            color: #e53e3e;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 5px;
        }
        .like-btn:hover {
            background: #e53e3e;
            color: white;
        }
        .like-btn.liked {
            background: #e53e3e;
            color: white;
        }
        .likes-count {
            margin-left: 5px;
            font-weight: bold;
        }
        .post-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .delete-btn {
            background: #e53e3e;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .delete-btn:hover {
            background: #c53030;
        }
        .edit-btn {
            background: #38a169;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
        }
        .edit-btn:hover {
            background: #2f855a;
        }
        .admin-badge {
            background: #d69e2e;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background: #4a5568;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-title {
            font-weight: bold;
            color: #cbd5e0;
            margin-bottom: 5px;
        }
        .search-result-content {
            color: #a0aec0;
            font-size: 14px;
        }
        .search-result-author {
            color: #4a90a4;
            font-size: 12px;
            margin-top: 5px;
        }
        .no-results {
            padding: 20px;
            text-align: center;
            color: #a0aec0;
        }
        .favorite-btn {
            background: none;
            border: 1px solid #d69e2e;
            color: #d69e2e;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 5px;
        }

        .favorite-btn:hover {
            background: #d69e2e;
            color: white;
        }

        .favorite-btn.active {
            background: #d69e2e;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üêü –ë–õ–û–ì –°–ï–õ–ï–î–ö–ò üêü</h1>
            <p>–ü–ò–®–ò —Å—é–¥–∞ —Ä–µ—Ü–µ–ø—Ç –ª—é–±–∏–º–æ–π —Å–µ–ª–µ–¥–æ—á–∫–∏ (–ú–û–ñ–ù–û —Å –∫–∞—Ä—Ç–æ—à–∫–æ–π)</p>
             <!-- –ü–û–ò–°–ö –ü–û–°–¢–û–í -->
        <div class="search-container" style="margin: 20px 0;">
            <input
                type="text"
                id="searchInput"
                placeholder="üîç –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–∫—Å—Ç—É..."
                style="
                    width: 100%;
                    max-width: 500px;
                    padding: 12px 20px;
                    background: #1a202c;
                    border: 2px solid #4a90a4;
                    color: #e2e8f0;
                    border-radius: 25px;
                    font-size: 16px;
                    outline: none;
                "
            >
            <div id="searchResults" style="
                display: none;
                position: absolute;
                background: #2d3748;
                border: 2px solid #4a90a4;
                border-radius: 8px;
                max-height: 300px;
                overflow-y: auto;
                width: 100%;
                max-width: 500px;
                margin-top: 5px;
                z-index: 1000;
            "></div>
        </div>
            <div id="userNav" class="nav-buttons">
                <a href="/login" class="btn btn-secondary">–í–û–ô–¢–ò</a>
                <a href="/register" class="btn btn-success">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</a>
            </div>

            <div id="userInfo" class="user-info" style="display: none;">
                –ü—Ä–∏–≤–µ—Ç, <span id="userLogin"></span><span id="adminBadge" class="admin-badge" style="display: none;">–ê–î–ú–ò–ù</span>!
                <a href="/create" class="btn">‚ûï –ù–û–í–´–ô –†–ï–¶–ï–ü–¢</a>
                <a href="/profile" class="btn">üë§ –ü–†–û–§–ò–õ–¨</a>
                <button onclick="logout()" class="btn btn-danger">üö™ –í–´–ô–¢–ò</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="postsContainer">
            {% for post in posts %}
            <div class="post" data-post-id="{{ post.id }}" data-author-id="{{ post.author_id }}">
                <h3>{{ post.title }}</h3>
                <div class="post-meta">
                    üìÖ –°–æ–∑–¥–∞–Ω–æ: {{ post.created_at.strftime('%d.%m.%Y %H:%M') }}
                    {% if post.updated_at != post.created_at %}
                    | ‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ post.updated_at.strftime('%d.%m.%Y %H:%M') }}
                    {% endif %}
                    | üë§ –ê–≤—Ç–æ—Ä: {{ post.author_login }}
                </div>
                <p style="color: #a0aec0;">{{ post.content[:200] }}{% if post.content|length > 200 %}...{% endif %}</p>
                <div class="post-actions">
                    <a href="/posts/{{ post.id }}" class="btn">üìñ –ß–ò–¢–ê–¢–¨ –†–ï–¶–ï–ü–¢</a>

                    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É –∏–ª–∏ –∞–¥–º–∏–Ω—É -->
                    <a href="/edit/{{ post.id }}" class="edit-btn" id="edit-btn-{{ post.id }}" style="display: none;">
                        ‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨
                    </a>

                    <button class="like-btn" onclick="toggleLike({{ post.id }})" id="like-btn-{{ post.id }}">
                        ‚ù§Ô∏è <span class="likes-count" id="likes-{{ post.id }}">0</span>
                    </button>
                    <button class="favorite-btn" onclick="toggleFavorite({{ post.id }})" id="favorite-btn-{{ post.id }}">
                        ‚≠ê
                    </button>


                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É –∏–ª–∏ –∞–¥–º–∏–Ω—É -->
                    <button class="delete-btn" onclick="deletePost({{ post.id }})" id="delete-btn-{{ post.id }}" style="display: none;">
                        üóëÔ∏è –£–î–ê–õ–ò–¢–¨
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div style="margin-top: 40px;">
            <a href="/create" class="btn">‚úçÔ∏è –ù–ê–ü–ò–°–ê–¢–¨ –†–ï–¶–ï–ü–¢</a>
            <a href="/docs" class="btn btn-secondary">üìö API –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø</a>
        </div>
    </div>

    <script>
    let currentUserId = null;
    let currentUserIsAdmin = false;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    async function loadCurrentUserInfo() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            console.log('üîê Loading user info...');

            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏–Ω –∏–∑ localStorage
            const userLogin = localStorage.getItem('login');
            console.log('üë§ User login from localStorage:', userLogin);

            if (!userLogin) {
                console.log('‚ùå No user login in localStorage');
                useLocalStorageData();
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –Ω–∞—Ö–æ–¥–∏–º –Ω–∞—à–µ–≥–æ –ø–æ –ª–æ–≥–∏–Ω—É
            const response = await fetch('/api/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const allUsers = await response.json();
                console.log('üìä All users:', allUsers);

                const currentUser = allUsers.find(user => user.login === userLogin);

                if (currentUser) {
                    currentUserId = currentUser.id;
                    currentUserIsAdmin = currentUser.is_admin;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    localStorage.setItem('user_id', currentUser.id.toString());
                    localStorage.setItem('is_admin', currentUser.is_admin.toString());

                    console.log('‚úÖ User info loaded successfully:', {
                        id: currentUserId,
                        login: currentUser.login,
                        is_admin: currentUserIsAdmin
                    });

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂ –∞–¥–º–∏–Ω–∞
                    if (currentUserIsAdmin) {
                        document.getElementById('adminBadge').style.display = 'inline-block';
                        console.log('üõ°Ô∏è User is ADMIN - showing admin badge');
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–º–∏
                    updatePostControls();
                } else {
                    console.error('‚ùå User not found in users list');
                    useLocalStorageData();
                }

            } else {
                console.error('‚ùå Failed to load users list:', response.status);
                useLocalStorageData();
            }

        } catch (error) {
            console.log('‚ùå Error loading user info:', error);
            useLocalStorageData();
        }
    }

    function useLocalStorageData() {
        currentUserId = localStorage.getItem('user_id');

        const storedIsAdmin = localStorage.getItem('is_admin');
        currentUserIsAdmin = storedIsAdmin === 'true';

        console.log('üîÑ Using localStorage data:', {
            id: currentUserId,
            storedIsAdmin: storedIsAdmin,
            currentUserIsAdmin: currentUserIsAdmin
        });

        if (currentUserIsAdmin) {
            document.getElementById('adminBadge').style.display = 'inline-block';
            console.log('üõ°Ô∏è User is ADMIN from localStorage');
        }
        updatePostControls();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
    function updatePostControls() {
        const posts = document.querySelectorAll('.post');
        console.log(`üîÑ Updating controls for ${posts.length} posts`);

        posts.forEach(post => {
            const postId = post.dataset.postId;
            const authorId = parseInt(post.dataset.authorId);
            const isAuthor = currentUserId && authorId === parseInt(currentUserId);
            const canEdit = isAuthor || currentUserIsAdmin;
            const canDelete = isAuthor || currentUserIsAdmin;

            const editBtn = document.getElementById(`edit-btn-${postId}`);
            const deleteBtn = document.getElementById(`delete-btn-${postId}`);

            console.log(`üìù Post ${postId}: author=${authorId}, current=${currentUserId}, isAuthor=${isAuthor}, isAdmin=${currentUserIsAdmin}, canEdit=${canEdit}, canDelete=${canDelete}`);

            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∞–≤—Ç–æ—Ä—É (–Ω–µ –∞–¥–º–∏–Ω—É –¥–ª—è —á—É–∂–∏—Ö –ø–æ—Å—Ç–æ–≤)
            if (editBtn) {
                editBtn.style.display = isAuthor ? 'inline-block' : 'none';
                console.log(`‚úèÔ∏è Edit button for post ${postId}: ${isAuthor ? 'SHOW' : 'HIDE'}`);
            }

            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä—É –ò–õ–ò –∞–¥–º–∏–Ω—É
            if (deleteBtn) {
                deleteBtn.style.display = canDelete ? 'inline-block' : 'none';
                console.log(`üóëÔ∏è Delete button for post ${postId}: ${canDelete ? 'SHOW' : 'HIDE'}`);
            }
        });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function checkAuth() {
            const token = localStorage.getItem('token');
            const userLogin = localStorage.getItem('login');
            currentUserId = localStorage.getItem('user_id');

            const storedIsAdmin = localStorage.getItem('is_admin');
            currentUserIsAdmin = storedIsAdmin === 'true';

            if (token && userLogin && currentUserId) {
                document.getElementById('userNav').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userLogin').textContent = userLogin;

                if (currentUserIsAdmin) {
                    document.getElementById('adminBadge').style.display = 'inline-block';
                }

                loadCurrentUserInfo();
                loadLikesInfo();
                loadFavoritesStatus();
            } else {
                document.getElementById('userNav').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
            }
            loadLikesCounts();
        }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
    async function deletePost(postId) {
        if (!confirm('‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            alert('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è!');
            window.location.href = '/login';
            return;
        }

        try {
            console.log(`üóëÔ∏è Deleting post ${postId} as user ${currentUserId} (admin: ${currentUserIsAdmin})`);

            const response = await fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                alert('‚úÖ –ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                // –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç –∏–∑ DOM
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (postElement) {
                    postElement.remove();
                }
            } else {
                const errorData = await response.json();
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', response.status, errorData);

                if (response.status === 401) {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                    logout();
                } else if (response.status === 403) {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + errorData.detail);
                } else if (response.status === 404) {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + errorData.detail);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorData.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤
    async function loadLikesCounts() {
        const posts = document.querySelectorAll('.post');

        for (const post of posts) {
            const postId = post.dataset.postId;
            try {
                const response = await fetch(`/api/likes/post/${postId}/count`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById(`likes-${postId}`).textContent = data.likes_count;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∞–π–∫–æ–≤:', error);
            }
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∞–π–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadLikesInfo() {
        const token = localStorage.getItem('token');
        if (!token) return;

        const posts = document.querySelectorAll('.post');

        for (const post of posts) {
            const postId = post.dataset.postId;
            try {
                const response = await fetch(`/api/likes/post/${postId}/check`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const likeBtn = document.getElementById(`like-btn-${postId}`);
                    if (likeBtn && data.liked) {
                        likeBtn.classList.add('liked');
                    }
                } else if (response.status === 401) {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∞–π–∫–æ–≤');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∞–π–∫–∞:', error);
            }
        }
    }

    // –õ–∞–π–∫
    async function toggleLike(postId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('–î–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è!');
            window.location.href = '/login';
            return;
        }

        try {
            const likeBtn = document.getElementById(`like-btn-${postId}`);
            const isLiked = likeBtn.classList.contains('liked');

            if (isLiked) {
                // –£–¥–∞–ª—è–µ–º –ª–∞–π–∫
                const response = await fetch(`/api/likes/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    likeBtn.classList.remove('liked');
                    loadLikesCounts();
                } else {
                    if (response.status === 401) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                        logout();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ª–∞–π–∫–∞');
                    }
                }
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫
                const response = await fetch('/api/likes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ post_id: postId })
                });

                if (response.ok) {
                    likeBtn.classList.add('liked');
                    loadLikesCounts();
                } else {
                    if (response.status === 401) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                        logout();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∞–π–∫–∞');
                    }
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ —Ä–µ—Ü–µ–ø—Ç–∞');
        }
    }
        async function toggleFavorite(postId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è!');
                window.location.href = '/login';
                return;
            }

            try {
                const favoriteBtn = document.getElementById(`favorite-btn-${postId}`);
                const isFavorite = favoriteBtn.classList.contains('active');

                if (isFavorite) {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    const response = await fetch(`/api/favorites/${postId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        favoriteBtn.classList.remove('active');
                        favoriteBtn.innerHTML = '‚≠ê';
                        showNotification('–†–µ—Ü–µ–ø—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
                    }
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    const response = await fetch(`/api/favorites/${postId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        favoriteBtn.classList.add('active');
                        favoriteBtn.innerHTML = '‚≠ê –í –ò–ó–ë–†–ê–ù–ù–û–ú';
                        showNotification('–†–µ—Ü–µ–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!', 'success');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º', 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–ª—è –ø–æ—Å—Ç–æ–≤
        async function loadFavoritesStatus() {
            const token = localStorage.getItem('token');
            if (!token) return;

            const posts = document.querySelectorAll('.post');

            for (const post of posts) {
                const postId = post.dataset.postId;
                try {
                    const response = await fetch(`/api/favorites/check/${postId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const favoriteBtn = document.getElementById(`favorite-btn-${postId}`);
                        if (favoriteBtn && data.is_favorite) {
                            favoriteBtn.classList.add('active');
                            favoriteBtn.innerHTML = '‚≠ê –í –ò–ó–ë–†–ê–ù–ù–û–ú';
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
                }
            }
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type) {
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#38a169' : '#e53e3e'};
                color: white;
                border-radius: 5px;
                z-index: 10000;
                font-weight: bold;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    // –í—ã—Ö–æ–¥
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user_id');
        localStorage.removeItem('login');
        localStorage.removeItem('is_admin');
        window.location.href = '/';
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', checkAuth);
    let searchTimeout = null;

    document.getElementById('searchInput').addEventListener('input', function(e) {
        const query = e.target.value.trim();
        const resultsContainer = document.getElementById('searchResults');

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        if (!query) {
            resultsContainer.style.display = 'none';
            return;
        }

            // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º
        searchTimeout = setTimeout(async () => {
            try {
                console.log(`üîç Searching for: "${query}"`);
                const response = await fetch(`/api/posts/search/?q=${encodeURIComponent(query)}`);

                if (response.ok) {
                    const results = await response.json();
                    displaySearchResults(results, query);
                } else {
                    console.error('Search error:', response.status);
                    resultsContainer.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                    resultsContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    resultsContainer.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
                    resultsContainer.style.display = 'block';
                }
            }, 300);
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        function displaySearchResults(results, query) {
            const resultsContainer = document.getElementById('searchResults');

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">üòî –†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            let html = '';
            results.forEach(post => {
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                const highlightedTitle = highlightText(post.title, query);
                const highlightedContent = highlightText(post.content.substring(0, 150), query);

                html += `
                    <div class="search-result-item" onclick="openPost(${post.id})">
                        <div class="search-result-title">${highlightedTitle}</div>
                        <div class="search-result-content">${highlightedContent}${post.content.length > 150 ? '...' : ''}</div>
                        <div class="search-result-author">üë§ ${post.author_login}</div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
        function highlightText(text, query) {
            if (!query) return text;

            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: #f6e05e; color: #1a202c;">$1</mark>');
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Å—Ç–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        function openPost(postId) {
            window.location.href = `/posts/${postId}`;
            // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
        }

        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–∏—Å–∫–∞
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-container');
            const searchResults = document.getElementById('searchResults');

            if (!searchContainer.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
</script>
</body>
</html>